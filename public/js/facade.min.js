/*!
 * facade.js v0.3.0-beta.7 2014-12-08T00:15:41
 * https://github.com/facadejs/facade.js
 * 
 * Copyright (c) 2014 Scott Doxey
 * Released under the MIT license.
 */
!function(a,b,c){"use strict";function d(a,c,e){if(!(this instanceof d))return new d(a,c,e);this.dt=null,this.fps=null,this.ftime=null,this._callback=null,this._requestAnimation=null,this._width=null,this._height=null,a&&"object"==typeof a&&1===a.nodeType?this.canvas=a:(this.canvas=b.createElement("canvas"),"string"==typeof a&&this.canvas.setAttribute("id",a)),c?this.width(c):this.canvas.hasAttribute("width")?this._width=parseInt(this.canvas.getAttribute("width"),10):this.width(this.canvas.clientWidth),e?this.height(e):this.canvas.hasAttribute("height")?this._height=parseInt(this.canvas.getAttribute("height"),10):this.height(this.canvas.clientHeight);try{this.context=this.canvas.getContext("2d")}catch(f){console.error("Object passed to Facade.js was not a valid canvas element.")}}var e,f,g,h=["fillStyle","font","globalAlpha","globalCompositeOperation","lineCap","lineJoin","lineWidth","miterLimit","shadowBlur","shadowColor","shadowOffsetX","shadowOffsetY","strokeStyle","textAlign","textBaseline"],i=Math.PI/180,j=new RegExp("^([-+])=");"undefined"!==String(typeof a)&&(g=b.createElement("canvas").getContext("2d"),["webkit","moz"].forEach(function(b){e=e||a.requestAnimationFrame||a[b+"RequestAnimationFrame"]||null,f=f||a.cancelAnimationFrame||a[b+"CancelAnimationFrame"]||null})),d.prototype.addToStage=function(a,b){var c,e;if(a instanceof d.Entity)a.draw(this,b);else if(Array.isArray(a))for(c=0,e=a.length;e>c;c+=1)this.addToStage(a[c],b);else console.error("Object passed to Facade.addToStage is not a valid Facade.js entity.");return this},d.prototype.clear=function(){return this.context.clearRect(0,0,this.width(),this.height()),this},d.prototype.draw=function(a){return"function"==typeof a?(this._callback=a,this.start()):console.error("Parameter passed to Facade.draw is not a valid function."),this},d.prototype.exportBase64=function(a,b){return a||(a="image/png"),"number"==typeof b?b/=100:b=1,this.canvas.toDataURL(a,b)},d.prototype.height=function(a){return a&&(this._height=parseInt(a,10),this.canvas.hasAttribute("data-resized-for-hdpi")?this.resizeForHDPI():this.canvas.setAttribute("height",this._height)),this._height},d.prototype.renderWithContext=function(a,b){var c,d,e=Object.keys(a);for(this.context.save(),c=0,d=e.length;d>c;c+=1)-1!==h.indexOf(e[c])?this.context[e[c]]=a[e[c]]:Array.isArray(a[e[c]])&&"function"==typeof this.context[e[c]]&&this.context[e[c]].apply(this.context,a[e[c]]);b&&b.call(null,this),this.context.restore()},d.prototype.resizeForHDPI=function(b){return b=b===c?a.devicePixelRatio:parseFloat(b),b>1&&(this.canvas.setAttribute("style","width: "+this.width()+"px; height: "+this.height()+"px;"),this.canvas.setAttribute("width",this.width()*b),this.canvas.setAttribute("height",this.height()*b),this.context.scale(b,b),this.canvas.setAttribute("data-resized-for-hdpi",!0)),this},d.prototype.start=function(){return this._requestAnimation=e(this._animate.bind(this)),this},d.prototype.stop=function(){return this.dt=null,this.fps=null,this.ftime=null,f(this._requestAnimation),this._requestAnimation=null,this},d.prototype.width=function(a){return a&&(this._width=parseInt(a,10),this.canvas.hasAttribute("data-resized-for-hdpi")?this.resizeForHDPI():this.canvas.setAttribute("width",this._width)),this._width},d.prototype._animate=function(a){return"function"==typeof this._callback?(this.ftime&&(this.dt=a-this.ftime,this.fps=(1e3/this.dt).toFixed(2)),this.ftime=a,this._requestAnimation=e(this._animate.bind(this)),this.context.save(),this._callback(),this.context.restore()):this.stop(),this},d.Entity=function(a){return this instanceof d.Entity?(this._options=this._defaultOptions(),this._metrics=this._defaultMetrics(),void this.setOptions(a)):new d.Entity},d.Entity.prototype._defaultOptions=function(a){var b,c,d,e;if(b={x:0,y:0,anchor:"top/left",rotate:0,scale:1},"object"==typeof a)for(c=Object.keys(a),d=0,e=c.length;e>d;d+=1)b[c[d]]=a[c[d]];return b},d.Entity.prototype._defaultMetrics=function(a){var b,c,d,e;if(b={x:null,y:null,width:null,height:null},"object"==typeof a)for(c=Object.keys(a),d=0,e=c.length;e>d;d+=1)b[c[d]]=a[c[d]];return b},d.Entity.prototype._getAnchorPoint=function(a,b){var c,e=[0,0];return a.anchor.match(/center$/)?e[0]=-b.width/2:a.anchor.match(/right$/)&&(e[0]=-b.width),a.anchor.match(/^center/)?e[1]=-b.height/2:a.anchor.match(/^bottom/)&&(e[1]=-b.height),this instanceof d.Polygon&&(c=this._getStrokeWidthOffset(a),e[0]=e[0]+c,e[1]=e[1]+c),e},d.Entity.prototype._getStrokeWidthOffset=function(a){var b=0;return a.lineWidth!==c&&(b=a.lineWidth/2),b},d.Entity.prototype._applyTransforms=function(a,b,c){var d=this._getAnchorPoint(b,{x:c.x,y:c.y,width:c.width/b.scale,height:c.height/b.scale});a.translate.apply(a,d),b.rotate&&(a.translate(-d[0],-d[1]),a.rotate(b.rotate*i),a.translate(d[0],d[1])),1!==b.scale&&(a.translate(-d[0],-d[1]),a.scale(b.scale,b.scale),a.translate(d[0],d[1]))},d.Entity.prototype.getOption=function(a){return this._options[a]!==c?this._options[a]:c},d.Entity.prototype.getAllOptions=function(){var a,b,c={},d=Object.keys(this._options);for(a=0,b=d.length;b>a;a+=1)c[d[a]]=this._options[d[a]];return c},d.Entity.prototype._setOption=function(a,b,d){var e;return this._options[a]!==c?("number"==typeof this._options[a]&&("string"==typeof b&&(e=b.match(j),e?(b=parseFloat(b.replace(j,"")),"+"===e[1]?b=this._options[a]+b:"-"===e[1]&&(b=this._options[a]-b)):b=parseFloat(b)),isNaN(b)&&(b=this._options[a],console.error("The value for "+a+" was not a valid number."))),String(typeof this._options[a])===String(typeof b)?d||(this._options[a]=b):console.error("The value for "+a+" ("+b+") was a "+String(typeof b)+" not a "+String(typeof this._options[a])+"."),b):c},d.Entity.prototype.setOptions=function(a,b){var d,e,f,g=this.getAllOptions();if(a){for(d=Object.keys(a),e=0,f=d.length;f>e;e+=1)g[d[e]]!==c&&(g[d[e]]=this._setOption(d[e],a[d[e]],b));b||this._setMetrics()}return g},d.Entity.prototype.getMetric=function(a){return this._metrics[a]!==c?this._metrics[a]:c},d.Entity.prototype.getAllMetrics=function(){var a,b,c={},d=Object.keys(this._metrics);for(a=0,b=d.length;b>a;a+=1)c[d[a]]=this._metrics[d[a]];return c},d.Entity.prototype.draw=function(a,b){var c,d=this.setOptions(b,!0);"function"==typeof this._configOptions&&(d=this._configOptions(d)),c=b?this._setMetrics(d):this.getAllMetrics(),"function"==typeof this._draw&&a.renderWithContext(d,this._draw.bind(this,a,d,c))},d.Polygon=function(a){return this instanceof d.Polygon?(this._options=this._defaultOptions(),this._metrics=this._defaultMetrics(),void this.setOptions(a)):new d.Polygon(a)},d.Polygon.prototype=Object.create(d.Entity.prototype),d.Polygon.constructor=d.Entity,d.Polygon.prototype._defaultOptions=function(a){var b,c,e,f;if(b=d.Entity.prototype._defaultOptions({opacity:100,points:[],fillStyle:"#000",strokeStyle:"",lineWidth:0,lineCap:"butt",lineJoin:"miter",closePath:!0}),a)for(c=Object.keys(a),e=0,f=c.length;f>e;e+=1)b[c[e]]=a[c[e]];return b},d.Polygon.prototype._draw=function(a,b,c){var d,e,f=a.context;if(this._applyTransforms(f,b,c),b.points.length){for(f.beginPath(),d=0,e=b.points.length;e>d;d+=1)6===b.points[d].length?f.bezierCurveTo.apply(f,b.points[d]):5===b.points[d].length?f.arc.apply(f,b.points[d]):2===b.points[d].length&&f.lineTo.apply(f,b.points[d]);b.closePath?f.closePath():f.moveTo.apply(f,b.points[e-1]),b.fillStyle&&f.fill(),b.lineWidth>0&&f.stroke()}},d.Polygon.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a},d.Polygon.prototype._setMetrics=function(a){var b,c,e,f,g=this._defaultMetrics(),h=a||this.getAllOptions(),i={top:null,right:null,bottom:null,left:null},j=this._getStrokeWidthOffset(h);for("function"==typeof this._configOptions&&(h=this._configOptions(h)),c=0,e=h.points.length;e>c;c+=1)2===h.points[c].length?b={x:h.points[c][0],y:h.points[c][1]}:5===h.points[c].length&&(g.width=2*h.points[c][2],g.height=2*h.points[c][2],b={x:h.points[c][0]-h.points[c][2],y:h.points[c][1]-h.points[c][2]}),(b.x<i.left||null===i.left)&&(i.left=b.x),(b.y<i.top||null===i.top)&&(i.top=b.y),(b.x>i.right||null===i.right)&&(i.right=b.x),(b.y>i.bottom||null===i.bottom)&&(i.bottom=b.y);return g.x=h.x+i.left,g.y=h.y+i.top,null===g.width&&null===g.height&&(g.width=i.right-i.left,g.height=i.bottom-i.top),g.width=(g.width+2*j)*h.scale,g.height=(g.height+2*j)*h.scale,f=this._getAnchorPoint(h,g),g.x=g.x+f[0]-j,g.y=g.y+f[1]-j,this instanceof d.Circle&&(g.x=g.x+h.radius,g.y=g.y+h.radius),a||(this._metrics=g),g},d.Circle=function(a){return this instanceof d.Circle?(this._options=this._defaultOptions({radius:0,begin:0,end:360,counterclockwise:!1}),this._metrics=this._defaultMetrics(),void this.setOptions(a)):new d.Circle(a)},d.Circle.prototype=Object.create(d.Polygon.prototype),d.Circle.constructor=d.Polygon,d.Circle.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a.points=a.counterclockwise?[[0,0,a.radius,a.end*i,a.begin*i]]:[[0,0,a.radius,a.begin*i,a.end*i]],a},d.Circle.prototype._getAnchorPoint=function(a,b){var c=d.Polygon.prototype._getAnchorPoint.call(this,a,b);return c[0]=c[0]+a.radius,c[1]=c[1]+a.radius,c},d.Circle.prototype._setMetrics=function(a){var b=d.Polygon.prototype._setMetrics.call(this,a),c=a||this.getAllOptions();return b.x=b.x-c.radius,b.y=b.y-c.radius,a||(this._metrics=b),b},d.Line=function(a){return this instanceof d.Line?(this._options=this._defaultOptions({x1:0,y1:0,x2:0,y2:0,lineWidth:1}),this._metrics=this._defaultMetrics(),void this.setOptions(a)):new d.Line(a)},d.Line.prototype=Object.create(d.Polygon.prototype),d.Line.constructor=d.Polygon,d.Line.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a.closePath=!1,a.points=[[a.x1,a.y1],[a.x2,a.y2]],a},d.Line.prototype._getAnchorPoint=function(a,b){var c=[0,0];return a.anchor.match(/center$/)?c[0]=-(b.width/2-a.lineWidth/2):a.anchor.match(/right$/)&&(c[0]=-(b.width-a.lineWidth)),a.anchor.match(/^center/)?c[1]=-(b.height/2-a.lineWidth/2):a.anchor.match(/^bottom/)&&(c[1]=-(b.height-a.lineWidth)),c},d.Rect=function(a){return this instanceof d.Rect?(this._options=this._defaultOptions({width:0,height:0}),this._metrics=this._defaultMetrics(),void this.setOptions(a)):new d.Rect(a)},d.Rect.prototype=Object.create(d.Polygon.prototype),d.Rect.constructor=d.Polygon,d.Rect.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a.points=[[0,0],[a.width,0],[a.width,a.height],[0,a.height]],a},d.Image=function(a,b){return this instanceof d.Image?(this._options=this._defaultOptions({width:0,height:0,tileX:1,tileY:1,offsetX:0,offsetY:0,frames:[0],speed:120,loop:!0,callback:function(){return c}}),this._metrics=this._defaultMetrics(),this.animating=!1,this.currentFrame=0,this.setOptions(b),void this.load(a)):new d.Image(a,b)},d.Image.prototype=Object.create(d.Entity.prototype),d.Image.constructor=d.Entity,d.Image.prototype.load=function(a){"object"==typeof a&&1===a.nodeType?this.image=a:(this.image=b.createElement("img"),this.image.setAttribute("src",a)),this.image.complete?this._setMetrics():this.image.addEventListener("load",this._setMetrics.bind(this,null))},d.Image.prototype.play=function(){return this.animating=!0,this},d.Image.prototype.pause=function(){return this.animating=!1,this},d.Image.prototype.reset=function(){return this.currentFrame=0,this},d.Image.prototype.stop=function(){return this.currentFrame=0,this.animating=!1,this},d.Image.prototype._configOptions=function(a){return a.translate=[a.x,a.y],this.image&&this.image.complete&&(a.width||(a.width=this.image.width),a.height||(a.height=this.image.height)),a},d.Image.prototype._setMetrics=function(a){var b,c=this._defaultMetrics(),d=a||this.getAllOptions();return"function"==typeof this._configOptions&&(d=this._configOptions(d)),c.width=d.width*d.tileX*d.scale,c.height=d.height*d.tileY*d.scale,b=this._getAnchorPoint(d,c),c.x=d.x+b[0],c.y=d.y+b[1],a||(this._metrics=c),c},d.Image.prototype._draw=function(a,b,c){var d,e,f=a.context,g=b.offsetX,h=b.offsetY,i=b.width,j=b.height,k=this.image.width,l=this.image.height;if(this.image.complete){for(this._applyTransforms(f,b,c),b.frames.length&&(g+=b.frames[this.currentFrame]*b.width,g+b.width>k&&(h+=Math.floor(g/k)*b.height,g%=k)),g+i>k&&(i=g+i-k),h+j>l&&(j=h+j-l),d=0;d<b.tileX;d+=1)for(e=0;e<b.tileY;e+=1)f.drawImage(this.image,g,h,i,j,b.width*d,b.height*e,i,j);this.animating&&(!this.ftime||a.ftime-this.ftime>=b.speed)&&(this.ftime&&(this.currentFrame+=1),this.ftime=a.ftime,this.currentFrame>=b.frames.length&&(b.loop?this.currentFrame=0:(this.currentFrame=b.frames.length-1,this.isAnimating=!1)),"function"==typeof b.callback&&b.callback.call(this,b.frames[this.currentFrame]))}},d.Text=function(a,b){return this instanceof d.Text?(this._options=this._defaultOptions({opacity:100,width:0,fontFamily:"Arial",fontStyle:"normal",fontSize:16,lineHeight:1,textAlignment:"left",textBaseline:"top",fillStyle:"#000",strokeStyle:"#000",lineWidth:0}),this._metrics=this._defaultMetrics(),this._maxLineWidth=0,this._lines=[],this.setOptions(b),void(a!==c&&this.setText(a))):new d.Text(a,b)},d.Text.prototype=Object.create(d.Entity.prototype),d.Text.constructor=d.Entity,d.Text.prototype.setText=function(a){var b,c,d=this.getAllOptions(),e=[],f=null,h="",i=0;for(this.value=a,this._maxLineWidth=d.width,this._lines=[],a&&(e=String(a).match(/\n|[\S]+ ?/g)),"function"==typeof this._configOptions&&(d=this._configOptions(d)),g.save(),g.font=d.font;e.length;)f=e.shift(),i=g.measureText(h+f.replace(/\s$/,"")).width,d.width>0&&i>d.width||f.match(/\n/)?(this._lines.push([h.replace(/\s$/,""),0,this._lines.length*d.fontSize*d.lineHeight]),h=f.replace(/\n/,"")):(h+=f,i>this._maxLineWidth&&(this._maxLineWidth=i));for(this._lines.push([h.replace(/\s$/,""),0,this._lines.length*d.fontSize*d.lineHeight]),b=0,c=this._lines.length;c>b;b+=1)i=g.measureText(this._lines[b][0]).width,"center"===d.textAlignment?this._lines[b][1]=(this._maxLineWidth-i)/2:"right"===d.textAlignment&&(this._lines[b][1]=this._maxLineWidth-i);return g.restore(),this._setMetrics(),this._lines},d.Text.prototype._draw=function(a,b,c){var d,e,f=a.context;for(this._applyTransforms(f,b,c),d=0,e=this._lines.length;e>d;d+=1)b.fillStyle&&f.fillText.apply(f,this._lines[d]),b.lineWidth&&f.strokeText.apply(f,this._lines[d])},d.Text.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a.font=a.fontStyle+" "+parseInt(a.fontSize,10)+"px "+a.fontFamily,0===a.width&&(a.width=this._maxLineWidth),a},d.Text.prototype._setMetrics=function(a){var b,c=this._defaultMetrics(),d=a||this.getAllOptions();return"function"==typeof this._configOptions&&(d=this._configOptions(d)),this._lines&&(c.width=d.width*d.scale,c.height=this._lines.length*d.fontSize*d.lineHeight*d.scale),b=this._getAnchorPoint(d,c),c.x=d.x+b[0],c.y=d.y+b[1],a||(this._metrics=c),c},d.Group=function(a){return this instanceof d.Group?(this._options=this._defaultOptions(),this._metrics=this._defaultMetrics(),this._objects=[],void this.setOptions(a)):new d.Group(a)},d.Group.prototype=Object.create(d.Entity.prototype),d.Group.constructor=d.Entity,d.Group.prototype._draw=function(a,b,c){var d,e,f=a.context;for(this._applyTransforms(f,b,c),d=0,e=this._objects.length;e>d;d+=1)a.addToStage(this._objects[d])},d.Group.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a},d.Group.prototype.addToGroup=function(a){var b,c;if(a instanceof d.Entity)this.hasEntity(a)||(this._objects.push(a),this._setMetrics());else if(Array.isArray(a))for(b=0,c=a.length;c>b;b+=1)this.addToGroup(a[b]);else console.error("Object passed to Facade.addToStage is not a valid Facade.js entity.")},d.Group.prototype.hasEntity=function(a){return-1!==this._objects.indexOf(a)},d.Group.prototype.removeFromGroup=function(a){a instanceof d.Entity&&this.hasEntity(a)&&(this._objects.splice(this._objects.indexOf(a),1),this._setMetrics())},d.Group.prototype._setMetrics=function(a){var b,c,d,e,f=this._defaultMetrics(),g=a||this.getAllOptions(),h={top:null,right:null,bottom:null,left:null};for(b=0,c=this._objects.length;c>b;b+=1)e=this._objects[b].getAllMetrics(),(e.x<h.left||null===h.left)&&(h.left=e.x),(e.y<h.top||null===h.top)&&(h.top=e.y),(e.x+e.width>h.right||null===h.right)&&(h.right=e.x+e.width),(e.y+e.height>h.bottom||null===h.bottom)&&(h.bottom=e.y+e.height);return f.x=g.x+h.left,f.y=g.y+h.top,f.width=(h.right-h.left)*g.scale,f.height=(h.bottom-h.top)*g.scale,d=this._getAnchorPoint(g,f),f.x=g.x+d[0],f.y=g.y+d[1],a||(this._metrics=f),f},"function"==typeof define&&define.amd!==c?define([],function(){return d}):"object"==typeof module&&module.exports!==c?module.exports=d:a.Facade=d}(window,document);